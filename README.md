# Datavillage Documentation

Created with [docusaurus-openapi-docs](https://github.com/PaloAltoNetworks/docusaurus-openapi-docs) plugin for [Docusaurus](https://docusaurus.io/).

## Start development server

To start the project, do the expected steps:

```bash
yarn
```

```bash
yarn build
```

```bash
yarn start
```

A development server will start on `http://localhost:3000`.

## File structure docs folder

When running `yarn build`, Docusaurus will parse the files in the `docs/` folder to static HTML pages that are saved in the `build` folder.

The `api` folder contains files generated by the [docusaurus-openapi-docs](https://github.com/PaloAltoNetworks/docusaurus-openapi-docs). **You should never manually edit these!**

The other subdirectories of `docs` contain manually created Markdown files.

## Generate from OpenAPI specs

This sections shows how to apply changes to the OpenAPI files in the `api/` folder and regenerate the corresponding files in the `docs/api` folder.

### Update latest version

Apply the needed changes to the corresponding yaml files in the `api/` folder. Then, run

```bash
yarn docusaurus clean-api-docs all
```

to clean the previously generated files, and

```bash
yarn docusaurus gen-api-docs all
```

to regenerate them. If the development server was already running, it should rebuild the static HTML files automatically.

In the `docusaurus.config.ts` file, you can find the ids of the different projects. To regenerate the files for a specific project, replace `all` with the id in the previous commands

> _Note:_ This will only generate the latest version. To regenerate all versions, continu reading

### Add new API version

#### Add OpenAPI specs

Let's say we have a project `cage-manager` on version `0.1.2`. We want to add `0.1.3` . Version `0.1.1` was released prior to `0.1.2`.
Before changing anything, clean up the generated files for the current version **of that project** with commands

```bash
yarn docusaurus clean-api-docs cage-manager
```

In the folder `api/cage-manager/` add the new specs in a new subdirectory named `0.1.3`.

#### Update configuration

Go to the file `docusaurus.config.ts` and look for the configuration of the docusaurus-plugin-openapi-docs plugin.
There should be an object structured as follows

```typescript
{
  ...
  config: {
    "cage-manager": {
      specPath: "...",
      ...,
      versions: {
        "0.1.1": {
          specPath: "api/cage-manager/0.1.0/api.yaml",
          outputDir: "docs/api/cage-manager/0.1.0",
          label: "v0.1.0",
          baseUrl: "/dv-documentation/docs/api/cage-manager/0.1.0",
        },
        ...
      }
    }
  }
}
```

In the `versions` object, add a new object with key `"0.1.2"`. It should have the same keys as the already existing ones. If you are unsure about the values, you can copy them from the `cage-manager` object one level up.

Update the values in the `cage-manager` object according to the new `0.1.3` version.

#### Regenerate specs

We will now update the `docs/api/` folder with the new specs.

First, generate files for the current version (v0.1.3):

```bash
yarn docusaurus clean-api-docs cage-manager
```

then, generate the files for the now legacy version 0.1.2:

```bash
yarn docusaurus clean-api-docs:version cage-manager:0.1.2
```

_replace `0.1.2` with `all` in the previous command to regenerate all legacy versions_

Running `yarn build` will result in failure as we still need to update the sidebar configuration

#### Update sidebars configuration

Open `sidebars.ts` and import the 0.1.2 sidebar as follows

```typescript
import cagemanager012sidebar from "./docs/api/cage-manager/0.1.2/sidebar";
```

In the `SidebarsConfig` array, search for the `cage-manager-0.1.2` key and replace

```typescript
{
  ...
  link: {
    ...
    slug: "/api/cage-manager"
  }
  items: cagemanagersidebar;
}
```

with

```typescript
{
  ...
  link: {
    ...
    slug: "/api/cage-manager/0.1.2"
  }
  items: cagemanager012sidebar;
}
```

Then, add a new object with key `cage-manager-0.1.3` that looks as follows:

```typescript
[
  ...
  "cage-manager-0.1.3": {
    {
      type: "html",
      defaultStyle: true,
      value: versionSelector(cagemanagerversions),
    },
    {
      type: "html",
      defaultStyle: true,
      value: versionCrumb("0.1.3"),
    },
    {
      type: "category",
      label: "Cage Manager latest",
      link: {
        type: "generated-index",
        title: "Cagemanager API",
        description: "Endpoints implemented in the Cage Manager",
        slug: "/api/cage-manager",
      },
      items: cagemanagersidebar,
    },
  }
]
```

You can now [start the development](#start-development-server) server to see the results.

## Global versions

In the future, we will want a way to version the platform, which will be a collection of versions of components that are well integrated. We can achieve this with [docusaurus versioning](https://docusaurus.io/docs/versioning) (you can already see it in action in the Docusaurus documentation itself)

We should be carefull with this as it significantly increases the size of the repository and makes it harder to manage. Also, we need to consider the fact that if someone wants to find the documentation of an older version of a certain component, that person needs to know to which global version this belongs.
